# ADR-002 — Границы и контракты модулей (Boundaries & Contracts)

---

## 1. Цель

Зафиксировать чёткие границы между модулями, форматы их публичных интерфейсов (HTTP, события, очереди, сервисы), правила идемпотентности и транзакционности.\
Все контракты приведены в финальной форме и обязаны соответствовать исходной структуре ADR-002 из исходных файлов проекта.

---

## 2. Модули и владение данными

Каждый модуль полностью владеет своими таблицами. Прямые SQL-запросы в чужие схемы запрещены.\
Любая межмодульная операция должна происходить через публичный интерфейс (`PublicService`) или через событие из `shared/events`.

| Модуль      | Отвечает за таблицы                                                                           | Имеет публичный интерфейс   |
| ----------- | --------------------------------------------------------------------------------------------- | --------------------------- |
| auth        | `auth.*`                                                                                      | `AuthPublicService`         |
| profiles    | `profiles`, `profile_services`, `profile_prices`, `profile_photos`, `profile_custom_services` | `ProfilesPublicService`     |
| media       | `profile_photos`, `profile_videos`                                                            | `MediaPublicService`        |
| moderation  | `moderation_tasks`, `moderation_decisions`                                                    | `ModerationPublicService`   |
| billing     | `billing_*`, `publication_orders`                                                             | `BillingPublicService`      |
| publication | `publication_prices`, `billing_profile_publication_orders`                                    | внутри BillingPublicService |

---

## 3. Контракты HTTP API (v1)

### 3.1 Auth

```
POST /v1/auth/email/request → { email } → 204
POST /v1/auth/email/verify → { email, code } → SessionDTO
POST /v1/auth/telegram/verify → { tg_code } → SessionDTO
DELETE /v1/auth/session → 204
```

**SessionDTO:** `{ userId: string, csrfToken: string }`

### 3.2 Profiles (владелец анкеты)

```
GET    /v1/me/profiles → ProfileSummary[]
POST   /v1/me/profiles → CreateProfileDTO → ProfileDTO
PATCH  /v1/me/profiles/:id → UpdateProfileDTO → ProfileDTO
POST   /v1/me/profiles/:id/submit → 202 (создаёт moderation task)
```

**Медиа:**

```
POST /v1/me/profiles/:id/photos/upload-url → {mime,size} → {url, fields, expiresAt}
POST /v1/me/profiles/:id/photos/confirm → {storageKey, sha256, size, width, height} → PhotoDTO
PATCH /v1/me/profiles/:id/photos/:photoId → {isCover?, orderIndex?} → PhotoDTO
DELETE /v1/me/profiles/:id/photos/:photoId → 204
```

**Цены / услуги:**

```
PUT /v1/me/profiles/:id/prices → PriceUpsertDTO[] → PriceDTO[]
PUT /v1/me/profiles/:id/services → ServiceBindDTO → 204
```

### 3.3 Витрина

```
GET /v1/profiles?category&cursor&limit → VitrineItem[] + nextCursor
GET /v1/profiles/:id → ProfilePublicDTO
```

### 3.4 Moderation (bot/backend)

```
POST /v1/moderation/tasks/:id/vote → {vote:'approve'|'needs_fix'|'reject', voterTgId} → 202
POST /v1/moderation/tasks/:id/decision → {decision, reasonCode?, notes?, decidedByTelegramUserId} → 201
```

### 3.5 Billing

```
POST /v1/billing/invoices → {asset} → InvoiceDTO
GET  /v1/billing/invoices/:id → InvoiceDTO
GET  /v1/billing/balance → BalanceDTO[]
POST /v1/billing/publication-orders → {profileId, periodDays} → PublicationOrderDTO
POST /v1/billing/publication-orders/:id/pay → {idempotencyKey} → 202
```

**Ошибки:** `{ code, message, details, traceId }`

---

## 4. События домена

**Общая форма:**

```ts
interface DomainEvent {
  name: string; // 'profile.submitted'
  id: string;   // ULID
  at: string;   // ISO UTC
  actor?: { type: 'user'|'system'|'bot'; id?: string };
  payload: Record<string, any>;
}
```

**Ключевые события:**

```
profile.submitted           { profileId, userId }
media.photo.processed       { profileId, photoId, nsfwScore?, sha256, isCover? }
moderation.task.created     { taskId, profileId, kind }
moderation.decision.applied { taskId, profileId, decision, fromStatus, toStatus }
billing.deposit.confirmed   { userId, currency, amountMinor, invoiceId, idempotencyKey }
billing.charge.confirmed    { userId, currency, amountMinor, refType, refId, idempotencyKey }
publication.order.paid      { orderId, profileId, startsAt, expiresAt }
publication.order.expired   { orderId, profileId }
```

---

## 5. Очереди BullMQ (межпроцессные контракты)

**Примеры:**

```ts
// media.process_photo
interface ProcessPhotoJob {
  profileId: string;
  photoId: string;
  storageKey: string;
  variants: Array<'card'|'thumb'|'watermarked'>;
}

// moderation.post_to_tg
interface PostToTelegramJob {
  taskId: string;
  profileId: string;
  kind: 'profile_full'|'photo'|'video';
  card: { title: string; text: string; coverUrl?: string };
}

// billing.settle
interface SettleJob {
  invoiceId: string;
  txHash: string;
  amountAsset: string;
  confirmations: number;
  idempotencyKey: string;
}
```

**Общие правила:** `maxAttempts=5`, экспоненциальный backoff, `*.dlq` при фатальной ошибке.\
Все операции с деньгами и публикациями — идемпотентны.

---

## 6. Публичные интерфейсы (`/libs/*/public`)

Каждый сервис имеет строго типизированный контракт для межмодульных вызовов.

**AuthPublicService:**

```ts
getSessionUser(req: Request): Promise<SessionUser|null>;
ensureRole(user: SessionUser, role: 'moderator'|'admin'): void;
audit(event: string, payload: Record<string, unknown>): Promise<void>;
```

**ProfilesPublicService:**

```ts
markPublishable(profileId: string, decidedBy?: string): Promise<void>;
markNeedsFix(profileId: string, notes?: string): Promise<void>;
markRejected(profileId: string, reason?: string): Promise<void>;
publishFromOrder(profileId: string, orderId: string, startsAt: Date, expiresAt: Date): Promise<void>;
isReadyToSubmit(profileId: string): Promise<{ok:boolean; reasons?:string[]}>;
```

**MediaPublicService:**

```ts
createPhotoRecord(profileId: string, storageKey: string, meta:{sha256:string,size:number,width:number,height:number}): Promise<{photoId:string}>;
setCover(profileId: string, photoId: string): Promise<void>;
reorder(profileId: string, photoId: string, orderIndex: number): Promise<void>;
```

**ModerationPublicService:**

```ts
createTask(input:{profileId:string;kind:'profile_full'|'photo'|'video';targetPhotoId?:string;targetVideoId?:string;aiScore?:number;aiPayload?:unknown;}): Promise<{taskId:string}>;
applyDecision(input:{taskId:string;decision:'approved'|'needs_fix'|'rejected';reasonCode?:string;notes?:string;decidedByTelegramUserId?:string;}): Promise<void>;
```

**BillingPublicService:**

```ts
createInvoice(userId:string, asset:string): Promise<{invoiceId:string;address:string;memo?:string;exactAmount:string}>;
getBalance(userId:string): Promise<Array<{currency:string;amountMinor:number}>>;
createPublicationOrder(userId:string, profileId:string, periodDays:number): Promise<{orderId:string;priceMinor:number;currency:string}>;
payPublicationOrder(userId:string, orderId:string, idemKey:string): Promise<void>;
```

---

## 7. Идемпотентность и транзакции

**Общие принципы:**

- Любая запись, изменяющая баланс, создаёт строку в `billing_transactions` с уникальным `idempotency_key`.
- Повторные вызовы безопасны и не изменяют состояние.
- `payPublicationOrder` — одна транзакция: `insert charge(out)` → `decrease balance` → `order.state='paid'` → emit `publication.order.paid`.
- `applyDecision` — атомарная операция: `insert moderation_decision` → смена `profiles.status` → `tasks.state='resolved'` → emit `moderation.decision.applied`.
- Фото — идемпотентны по `(photoId, sha256)`.

---

## 8. Тестовая матрица контрактов

- **Auth:** проверка истёкшего и корректного кода, повторных логинов.
- **Profiles:** submit без фото/цен → 400; успешный → `profile.submitted`.
- **Media:** confirm без presigned → 400; успешный → `media.photo.processed`.
- **Moderation:** vote + decision → `profiles.status` меняется, задача закрыта.
- **Billing:** двойной settle одной `tx` не удваивает баланс; `payPublicationOrder` идемпотентен.

---

## 9. Definition of Done (для ADR-002)

- Интерфейсы `/libs/*/public` созданы и типизированы.
- Контроллеры и DTO валидируются по Zod/class-validator.
- EventBus настроен, события типизированы.
- Очереди BullMQ заведены.
- Формат ошибок `{code,message,details,traceId}` внедрён.
- Rate limits включены.
- Интеграционные тесты проверяют happy-path и идемпотентность.

---

**Резюме:**\
ADR-002 фиксирует все контракты между доменами, события, очереди и публичные сервисы Aboba.\
Эти контракты обеспечивают предсказуемость поведения при разработке и поддержку идемпотентности в критических потоках — биллинг, модерация и публикации.

