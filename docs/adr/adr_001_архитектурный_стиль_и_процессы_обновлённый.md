# ADR-001 — Архитектурный стиль и процессы

---

## 1. Контекст

Проект **Aboba** реализуется как **модульный монолит на NestJS (Node LTS)** с отдельными процессами для API, Telegram-бота и фоновых воркеров. Архитектура построена на принципах событийно-ориентированного взаимодействия между изолированными доменами, но при этом использует единое хранилище (PostgreSQL) как источник истины.

Основная цель ADR-001 — зафиксировать продовую архитектуру, минимальную инфраструктуру, правила масштабирования и критерии готовности.

Данный документ отражает финальный дизайн, изложенный в исходных ADR-файлах (001 из пакета Aboba)【153†aboba (17).pdf†L5-L60】.

---

## 2. Архитектурный стиль

**Тип:** модульный монолит с event-driven взаимодействием.\
**Фреймворк:** NestJS.\
**Язык:** TypeScript (Node LTS).\
**Процессы:**

- **api** — основной REST-сервис;
- **bot** — Telegram-модерация и AI-интеграция;
- **workers** — BullMQ-очереди для медиа, биллинга, публикаций и модерации.

**Хранилища:**

- PostgreSQL (RDS Multi-AZ) — источник истины;
- Redis (ElastiCache) — очереди, rate limits, сессии;
- S3 — медиафайлы (оригиналы и derived);
- (опц.) Prometheus + Loki — метрики и логи.

---

## 3. Модули и зависимости

| Модуль      | Назначение                         | Основные таблицы                                                   |
| ----------- | ---------------------------------- | ------------------------------------------------------------------ |
| auth        | пользователи, сессии, идентичности | `auth.users`, `auth.sessions`, `auth.auth_identities`              |
| profiles    | анкеты, услуги, фото, цены         | `profiles`, `profile_services`, `profile_prices`, `profile_photos` |
| media       | обработка фото/видео, S3           | `profile_photos`, `profile_videos`                                 |
| moderation  | AI и ручная проверка               | `moderation_tasks`, `moderation_decisions`                         |
| billing     | депозиты, балансы, транзакции      | `billing_*`                                                        |
| publication | заказы и публикации анкет          | `billing_profile_publication_orders`                                |
| shared      | общие типы, events, utils          | без прямых ссылок на домены                                        |

**Правила:**

- Прямой доступ к чужим таблицам запрещён — только через публичные сервисы и события.
- `shared` не импортирует доменные модули.
- Все обращения к БД — через DAO/Repository-уровень.

**Публичные события:**

```
profile.submitted | profile.publishable | profile.published | profile.needs_fix | profile.rejected
media.photo.processed | media.photo.failed
moderation.task.created | moderation.decision.applied
billing.deposit.confirmed | billing.charge.confirmed
publication.order.paid | publication.order.expired
```

---

## 4. Процессы и масштабирование

**api:** stateless; масштабирование горизонтальное по CPU/RPS.\
**bot:** отдельный webhook endpoint; масштабируется независимо.\
**workers:** пул воркеров на тип очереди, автоскейлинг по длине очереди.

**BullMQ Очереди:**

```
media.process_photo
media.process_video (опц.)
moderation.post_to_tg
billing.watch.btc|eth|bsc|tron|xrp
billing.settle
publication.expire
publication.remind
```

**Ретраи:** экспоненциальная задержка, `maxAttempts=5`, `*.dlq` для dead-letter.

---

## 5. Инфраструктура (prod-ready минималка)

- **DB:** Amazon RDS PostgreSQL (Multi-AZ, autoscaling, pgBouncer опц.)
- **Redis:** ElastiCache (cluster-enabled при росте)
- **S3:** два бакета: `aboba-media-original` (приватный), `aboba-media-derived` (приватный, раздача через signed URL, TTL=10m)
- **Compute:** ECS Fargate + ALB + ACM (TLS), blue/green деплой через CodeDeploy
- **Secrets:** AWS Secrets Manager, ротация 90 дней
- **CI/CD:** GitHub Actions → ECR → ECS; миграции отдельной job перед деплоем

---

## 6. Безопасность и сетевой периметр

- **WAF** (SQLi/XSS/bot rate limit) перед ALB.
- **CORS/CSRF:** double-submit или Origin-check.
- **Cookies:** `HttpOnly`, `Secure`, `SameSite=Lax/Strict`; JWT не используется в браузере.
- **PII & Медиа:** EXIF-strip, watermark на derived; оригиналы доступны только воркерам.
- **RBAC:** роли `user`, `moderator`, `admin`, `bot` (service account).
- **Signed URLs:** TTL = 10 минут.

---

## 7. Надёжность и миграции

- **Миграции:** Flyway/Prisma/TypeORM, forward-only, dry-run перед продом.
- **Rollback:** только через бэкапы и safe down-скрипты.
- **Backups:** автоматические (7–14 дней), точечное восстановление; тест восстановления 1 раз в месяц.
- **Retention:** AI payload хранится 90 дней.
- **Idempotency:** все `billing_transactions` с `idempotency_key UNIQUE`.
- **Consistency:** операции публикации (`charge→balance→order.paid→profile.published`) выполняются в одной транзакции.

---

## 8. Наблюдаемость и SLO

- **Логи:** pino (JSON), `request_id`/`job_id` корреляция, retention 30 дней.
- **Метрики:** `/metrics` (Prometheus): latency p95/p99, queue lag, on-chain lag, error rate.
- **Health:** `/health/live` и `/health/ready`.
- **Tracing:** OTEL (опц.), trace\_id в логах.

**SLO (MVP):**

- API availability ≥ 99.5% / месяц.
- p95 latency < 300ms (GET), < 800ms (POST).
- 90% фото обработано < 60с.
- On-chain settle ≤ 2 блока (XRP ≤ 1 мин).

Error Budget: 0.5% downtime → блок новых релизов при превышении.

---

## 9. API и версии

- **REST/JSON**, пагинация `cursor/limit`.
- **Формат ошибок:** `{ code, message, details }`.
- **OpenAPI v3** генерируется из кода (`/docs`).
- Версионирование `/v1`; breaking changes → `/v2`.
- **Публичные ID:** UUID/ULID или безопасные числовые ID.

---

## 10. Конфигурация среды

| ENV               | Назначение     |
| ----------------- | -------------- |
| DATABASE\_URL     | DSN Postgres   |
| REDIS\_URL        | DSN Redis      |
| S3\_\*            | Ключи и бакеты |
| SESSION\_SECRET   | Секрет сессий  |
| TELEGRAM\_\*      | Настройки бота |
| RPC\_ENDPOINTS    | Ончейн сети    |
| ORIGIN            | Домен фронта   |
| WAF\_TRUSTED\_IPS | Белый список   |

**Окружения:** dev (MinIO/local DB), staging (песочницы), prod.\
**Feature flags:** через ENV (например, `ENABLE_VIDEO=false`).

---

## 11. Выбор монолита (Trade-offs)

**Плюсы:** транзакционность, простота DevOps, скорость релизов.\
**Минусы:** общий failure domain.\
**Компенсация:** процессная изоляция (`api/bot/workers`), очереди, чёткие границы модулей.\
**План на будущее:** выделение сервисов при росте TPS в billing/media или региональной нагрузке.

---

## 12. Критерии принятия (Definition of Done)

- Репозиторий с `/apps/api`, `/apps/bot`, `/apps/workers`.
- Настроены PostgreSQL, Redis, S3, очереди, health-checks, Swagger, метрики.
- CI/CD c миграциями и blue/green деплоем.
- Terraform/CFN стэки для RDS/Redis/S3/ECS/ALB.
- Документированы ENV и политики секретов.

---

---

**Резюме:**\
ADR-001 формализует архитектурный стиль Aboba: модульный монолит с событийным взаимодействием, безопасной инфраструктурой AWS, очередями BullMQ, наблюдаемостью и готовностью к масштабированию по процессам.\
Это целевая архитектура MVP, проверенная для выхода в production.

